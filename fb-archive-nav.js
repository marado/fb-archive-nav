// @license magnet:?xt=urn:btih:0b31508aeb0634b347b8270c7bee4d411b5d4109&dn=agpl-3.0.txt AGPL-3.0
//
// fb-archive-nav.js is free software: you can redistribute it and/or modify it
// under the terms of the GNU Affero General Public License as published by the
// Free Software Foundation, either version 3 of the License, or (at your
// option) any later version.
//
// (c) Marcos Marado <mindboosternoori@gmail.com>, 2025
//
// The latest version of the software can probably be found at
// https://github.com/marado/fb-archive-nav

// Note: this script was made using only one archive as an example. It assumes
// things that might not be entirely correct. For eg:
//
// * that u_0_1f6_2m is the header's h1 id
// * that _2pin is the if of the content divs
//
// If you find these (or any other) assumptions are wrong, please open an issue
// so they can be corrected!

// when an year query string is presented, we assume that is the selected year
function selectedYear() {
	return new URL(location).searchParams.get('year');
}

function identity() {
	const asides = document.querySelectorAll('aside');
	// we assume there is only one aside. should we?
	const split = asides[0].textContent.split(" on ");
	// there's probably a better way to do this, but...
	var name = split[0].substring(13); // 13 being the length of "Generated by "
	for (var i = 1; i < split.length - 1; i++) { name += " " + split[i]; }
	var newtitle = name + " " + document.title.substring(5);
	if (selectedYear() !== null) newtitle += " (" + selectedYear() + ")";
	document.title = newtitle;
	document.getElementById("u_0_1f6_2m").innerHTML = newtitle;
	delete newtite;
	delete name;
	delete split;
	delete asides;
	// removing "you've" from another string:
	document.getElementsByClassName("_a70f")[0].innerHTML="Photos, videos, text and status updates shared on Facebook";
}

function yearNav() {
	var years = new Set(); // let's know all represented years
	var tmp = new Array(); // maybe there's a better way than having to sort an array, but for now this works
	const filterByYear = (selectedYear() !== null); // if there's an year, we'll filter...
	const sections = document.querySelectorAll('section');
	sections.forEach(section => {
		const dDivs = section.querySelectorAll('div._a72d'); // the timestamp divs! every section has one and only one
		const dDiv = dDivs[0];
		const date = dDiv.textContent.trim(); // we'll need the full date to order the sections, maybe not here...
		const year = date.split(", ")[1].substring(0,4);
		tmp.push(year);
		if (filterByYear && (year !== selectedYear())) {
			section.style.display = "none";
		}
	});
	for (const year of tmp.sort()) years.add(year);
	var navHTML = "<p/>";
	years.forEach(year => {
		if (selectedYear() !== year) {
			navHTML += " [<a href=\"" + location.pathname + "?year=" + year + "\">" + year + "</a>] ";
		} else {
			navHTML += " [" + year + "] ";
		}
	});
	const asides = document.querySelectorAll('aside');
	asides[0].innerHTML += navHTML;
	delete asides;
	delete tmp;
	delete sections;
	delete filterByYear;
	delete years;
}

function order() {
	// TODO
}

function hideEmpty() {
	const sections = document.querySelectorAll('section');
	sections.forEach(section => {
		const pinDivs = section.querySelectorAll('div._2pin');
		// There are "a few" (more than 1000, on my archive) sections with only one <div class="_2pin">, and where that div is empty.
		// In those cases, we want to hide that entire section...
		if (pinDivs.length === 1) {
			const pinDiv = pinDivs[0];
			const isEmpty = ((pinDiv.textContent.trim() === "") && (pinDiv.children.length === 1));
			if (isEmpty) {
				section.style.display = "none";
			}
			delete isEmpty;
			delete pinDiv;
		} else if (pinDivs.length === 2) {
			// is one empty and the other an update string? If so, hide it too
			const pinDiv = pinDivs[0];
			const isEmpty = ((pinDiv.textContent.trim() === "") && (pinDiv.children.length === 1));
			if (isEmpty) {
				// And update string goes more or less like this: "Updated Feb 25, 2025 7:48:26 pm"
				// We're going to assume that any string that is 40 characters or less and starts with "Updated " is one.
				const testString = pinDivs[1].textContent.trim();
				if (testString.startsWith("Updated ") && (testString.length <= 40)) {
					// consider this an update string, and this section one that should be hidden
					section.style.display = "none";
				}
				delete testString;
			}
			delete isEmpty;
			delete pinDiv;
		}
		delete pinDivs;
	});
	delete sections;
}

function showFooter() {
	var footerElement = document.createElement("pagefooter");
	footerElement.innerHTML = "<div id=\"footer\" style=\"text-align:center;\">This archive's navigation is powered by <a href=\"https://github.com/marado/fb-archive-nav\">fb-archive-nav</a>.</div>";
	document.body.appendChild(footerElement);
	delete footerElement;
}

function stripDyi() {
	// Leave the text on those links but remove the anchors
	const footers = document.querySelectorAll('footer');
	footers.forEach(footer => {
		const date = footer.querySelectorAll('a')[0].innerHTML;
		footer.innerHTML = date;
	});
	delete footers;
}

// FIXME: this is quite inefficient: some of the functions called will cycle
//        through everything (at least once) and we'll be doing it over and over
//        again... Once this is implemented, let's optimize it!
// footer boolean parameter - if exists and false, the footer won't be shown
// dyi    boolean parameter - if exists and false, the dyi links won't be stripped
function fbArchiveNav(footer, dyi) {
	// According to the README, this is this script achieves:
	// * You want to announce it as your activity, not the readers;
	identity();
	// * You want to be able to navigate by year;
	yearNav();
	// * You want to hide all those empty entries that are showed up in there;
	hideEmpty();
	// * You want the page data to be shown in chronologic order...
	order();
	// * footer of the page something about the navigator
	if (typeof(footer) === 'undefined' || footer) showFooter();
	// * removal of dyi (download your information) links
	if (typeof(footer) === 'undefined' || dyi) stripDyi();
}
// @license-end" 
